

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Python &mdash; TECA  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/collapsible-lists/css/tree_view.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script src="_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Development" href="developer.html" />
    <link rel="prev" title="Applications" href="applications.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> TECA
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="applications.html">Applications</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Python</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#pipeline-construction-configuration-and-execution">Pipeline Construction, Configuration and Execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="#algorithm-development">Algorithm Development</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#report-phase">Report Phase</a></li>
<li class="toctree-l3"><a class="reference internal" href="#request-phase">Request Phase</a></li>
<li class="toctree-l3"><a class="reference internal" href="#execute">Execute</a></li>
<li class="toctree-l3"><a class="reference internal" href="#python-algorithm-template">Python Algorithm Template</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-report-override">The Report Override</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-request-override">The Request Override</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-execute-override">The Execute Override</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#working-with-teca-s-data-structures">Working with TECA’s Data Structures</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#arrays">Arrays</a></li>
<li class="toctree-l3"><a class="reference internal" href="#metadata">Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="#array-collections">Array Collections</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tables">Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cartesian-meshes">Cartesian Meshes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#netcdf-cf-reader-metadata">NetCDF CF Reader Metadata</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="developer.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/framework_root.html">Framework</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">TECA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Python</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/python.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="python">
<h1>Python<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h1>
<p>TECA includes a diverse collection of I/O and analysis algorithms specific to
climate science and extreme event detection. It’s pipeline design allows these
component algorithms to be quickly coupled together to construct complex data
processing and analysis pipelines with minimal effort. TECA is written
primarily in C++11 in order to deliver the highest possible performance and
scalability. However, for non-computer scientists c+11 development can be
intimidating, error prone, and time consuming. TECA’s Python bindings offer a
more approachable path for custom application and algorithm development.</p>
<p>Python can be viewed as glue for connecting optimized C++11 components. Using
Python as glue gives one all of the convenience and flexibility of Python
scripting with all of the performance of the native C++11 code. TECA also
includes a path for fully Python based algorithm development where the
programmer provides Python callables that implement the desired analysis. In
this scenario the use of technologies such as NumPy provide reasonable
performance while allowing the programmer to focus on the algorithm itself
rather than the technical details of C++11 development.</p>
<div class="figure align-default" id="id1">
<span id="parallel-exec"></span><a class="reference internal image-reference" href="_images/parallel_exec.png"><img alt="_images/parallel_exec.png" src="_images/parallel_exec.png" style="width: 100%; height: 2.5in;" /></a>
<p class="caption"><span class="caption-number">Fig. 12 </span><span class="caption-text">execution path through a simple 4 stage pipeline on any given process in an
MPI parallel run. Time progresses from a1 to c4 through the three execution
phases report (a), request (b), and execute (c). The sequence of thread
parallel execution is shown inside gray boxes, each path represents the
processing of a single request.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="pipeline-construction-configuration-and-execution">
<span id="py-glue"></span><h2>Pipeline Construction, Configuration and Execution<a class="headerlink" href="#pipeline-construction-configuration-and-execution" title="Permalink to this headline">¶</a></h2>
<p>Building pipelines in TECA is as simple as creating and connecting TECA
algorithms together in the desired order. Data will flow and be processed
sequentially from the top of the pipeline to the bottom, and in parallel where
parallel algorithms are used. All algorithms are created by their static New()
method. The connections between algorithms are made by calling one algorithm’s
set_input_connection() method with the return of another algorithm’s
get_output_port() method. Arbitrarily branchy pipelines are supported. The
only limitation on pipeline complexity is that cycles are not allowed. Each
algorithm represents a stage in the pipeline and has a set of properties that
configure its run time behavior. Properties are accessed by set_&lt;prop
name&gt;() and get_&lt;prop name&gt;() methods. Once a pipeline is created and
configured it can be run by calling update() on its last algorithm.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<span id="py-glue-code"></span><div class="code-block-caption"><span class="caption-number">Listing 1 </span><span class="caption-text">Command line application written in Python. The application constructs, configures, and executes a 4 stage pipeline that computes basic descriptive statistics over the entire lat-lon mesh for a set of variables passed on the command line. The statistic computations have been written in Python, and are shown in listing <a class="reference internal" href="#py-devel-code"><span class="std std-numref">Listing 2</span></a>. When run in parallel, the map-reduce pattern is applied over the time steps in the input dataset. A graphical representation of the pipeline is shown in figure <a class="reference internal" href="#parallel-exec"><span class="std std-numref">Fig. 12</span></a></span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">teca</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">stats_callbacks</span> <span class="kn">import</span> <span class="n">descriptive_stats</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;global_stats.py [dataset regex] &#39;</span> \
        <span class="s1">&#39;[out file name] [first step] [last step] [n threads]&#39;</span> \
        <span class="s1">&#39;[array 1] .. [ array n]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">data_regex</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">out_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">first_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">last_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<span class="n">n_threads</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="n">var_names</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>

<span class="k">if</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Testing on </span><span class="si">%d</span><span class="s1"> MPI processes</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()))</span>

<span class="n">cfr</span> <span class="o">=</span> <span class="n">teca_cf_reader</span><span class="o">.</span><span class="n">New</span><span class="p">()</span>
<span class="n">cfr</span><span class="o">.</span><span class="n">set_files_regex</span><span class="p">(</span><span class="n">data_regex</span><span class="p">)</span>

<span class="n">alg</span> <span class="o">=</span> <span class="n">descriptive_stats</span><span class="o">.</span><span class="n">New</span><span class="p">()</span>
<span class="n">alg</span><span class="o">.</span><span class="n">set_input_connection</span><span class="p">(</span><span class="n">cfr</span><span class="o">.</span><span class="n">get_output_port</span><span class="p">())</span>
<span class="n">alg</span><span class="o">.</span><span class="n">set_variable_names</span><span class="p">(</span><span class="n">var_names</span><span class="p">)</span>

<span class="n">mr</span> <span class="o">=</span> <span class="n">teca_table_reduce</span><span class="o">.</span><span class="n">New</span><span class="p">()</span>
<span class="n">mr</span><span class="o">.</span><span class="n">set_input_connection</span><span class="p">(</span><span class="n">alg</span><span class="o">.</span><span class="n">get_output_port</span><span class="p">())</span>
<span class="n">mr</span><span class="o">.</span><span class="n">set_thread_pool_size</span><span class="p">(</span><span class="n">n_threads</span><span class="p">)</span>
<span class="n">mr</span><span class="o">.</span><span class="n">set_start_index</span><span class="p">(</span><span class="n">first_step</span><span class="p">)</span>
<span class="n">mr</span><span class="o">.</span><span class="n">set_end_index</span><span class="p">(</span><span class="n">last_step</span><span class="p">)</span>

<span class="n">tw</span> <span class="o">=</span> <span class="n">teca_table_writer</span><span class="o">.</span><span class="n">New</span><span class="p">()</span>
<span class="n">tw</span><span class="o">.</span><span class="n">set_input_connection</span><span class="p">(</span><span class="n">mr</span><span class="o">.</span><span class="n">get_output_port</span><span class="p">())</span>
<span class="n">tw</span><span class="o">.</span><span class="n">set_file_name</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>

<span class="n">tw</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<p>For example, listing <a class="reference internal" href="#py-glue-code"><span class="std std-numref">Listing 1</span></a> shows a command line application
written in Python. The application computes a set of descriptive statistics
over a list of arrays for each time step in the dataset. The results at each
time step are stored in a row of a table. teca_table_reduce is a map-reduce
implementation that processes time steps in parallel and reduces the tables
produced at each time step into a single result. One use potential use of this
code would be to compute a time series of average global temperature. The
application loads modules and initializes MPI (lines 1-4), parses the command
line options (lines 6-17),  constructs and configures the pipeline (lines
22-37), and finally executes the pipeline (line 39). The pipeline constructed
is shown in figure <a class="reference internal" href="#parallel-exec"><span class="std std-numref">Fig. 12</span></a> next to a time line of the
pipeline’s parallel execution on an arbitrary MPI process.</p>
</div>
<div class="section" id="algorithm-development">
<span id="py-devel"></span><h2>Algorithm Development<a class="headerlink" href="#algorithm-development" title="Permalink to this headline">¶</a></h2>
<p>While TECA is is written in C++11, it can be extended at run time using Python.
However, before we explain how this is done one must know a little about the
three phases of execution and what is expected to happen during each.</p>
<p>The heart of TECA’s pipeline implementation is the teca_algorithm. This is an
abstract class that contains all of the control and execution logic. All
pipelines in TECA are built by connecting concrete implementations of
teca_algorithm together to form execution networks. TECA’s pipeline model is
based on a report-request scheme that minimizes I/O and computation. The role
of reports are to make known to down stream consumers what data is available.
Requests then are used to pull only the data that is needed through the
pipeline. Requests enable subsetting and streaming of data and can be acted
upon in parallel and are used as keys in the pipeline’s internal cache. The
pipeline has 3 phases of execution, report phase, the request phase, and
finally the execute phase.</p>
<div class="section" id="report-phase">
<h3>Report Phase<a class="headerlink" href="#report-phase" title="Permalink to this headline">¶</a></h3>
<p>The report phase kicks off a pipeline’s execution and is initiated when the
user calls update() or update_metadata() on a teca_algorithm. In the report
phase, starting at the top of the pipeline working sequentially down, each
algorithm examines the incoming report and generates outgoing report about what
it will produce. Implementing the report phase can be as simple as adding an
array name to the list of arrays or as complex as building metadata describing
a dataset on disk. The report phase should always be light and fast. In cases
where it is not, cache the report for re-use. Where metadata generation would
create a scalability issue, for instance parsing data on disk, the report
should be generated on rank 0 and broadcast to the other ranks.</p>
</div>
<div class="section" id="request-phase">
<h3>Request Phase<a class="headerlink" href="#request-phase" title="Permalink to this headline">¶</a></h3>
<p>The request phase begins when report the report phase
reaches the bottom of the pipeline. In the request phase, starting at the
bottom of the pipeline working sequentially up, each algorithm examines the
incoming request, and the report of what’s available on its inputs, and from
this information generates a request for the data it will need during its
execution phase. Implementing the request phase can be as simple as adding a
list of arrays required to compute a derived quantity or as complex as
requesting data from multiple time steps for a temporal computation. The
returned requests are propagated up after mapping them round robin onto the
algorithm’s inputs. Thus, it’s possible to request data from each of the
algorithm’s inputs and to make multiple requests per execution. Note that when
a threaded algorithm is in the pipeline, requests are dispatched by the thread
pool and request phase code must be thread safe.</p>
</div>
<div class="section" id="execute">
<h3>Execute<a class="headerlink" href="#execute" title="Permalink to this headline">¶</a></h3>
<p>The execute phase begins when requests reach the top of the
pipeline. In the execute phase, starting at the top of the pipeline and working
sequentially down, each algorithm handles the incoming request, typically by
taking some action or generating data. The datasets passed into the execute
phase should never be modified. When a threaded algorithm is in the pipeline,
execute code must be thread safe.</p>
<p>In the TECA pipeline the report and request execution phases handle
communication in between various stages of the pipeline. The medium for these
exchanges of information is the teca_metadata object, an associative
containers mapping strings(keys) to arrays(values). For the stages of a
pipeline to communicate all that is required is that they agree on a key naming
convention. This is both the strength and weakness of this approach. On the one
hand, it’s trivial to extend by adding keys and arbitrarily complex information
may be exchanged. On the other hand, key naming conventions can’t be easily
enforced leaving it up to developers to ensure that algorithms play nicely
together. In practice the majority of the metadata conventions are defined by
the reader. All algorithms sitting down stream must be aware of and adopt the
reader’s metadata convention. For most use cases the reader will be TECA’s
NetCDF CF 2.0 reader, teca_cf_reader. The convention adopted by the CF reader
are documented in its header file and in section ref{sec:cf_reader}.</p>
<p>In C++ and Python polymorphism is used to provide customized behavior for each
of the three pipeline phases. In Python we use the teca_python_algorithm, an
adapter class that connects the user provided overrides such that they are
called at the appropriate times during each phase of pipeline execution. Hence
writing a TECA algorithm purely in Python amounts to providing three
appropriate overrides.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<span id="py-devel-code"></span><div class="code-block-caption"><span class="caption-number">Listing 2 </span><span class="caption-text">Overrides implementing the calculation of descriptive statistics over a set of variables laid out on a Cartesian lat-lon mesh. The request override requests the variables, the execute override makes the computations and constructs a table to store them in.</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">teca</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">class</span> <span class="nc">descriptive_stats</span><span class="p">(</span><span class="n">teca_python_algorithm</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">set_variable_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_names</span> <span class="o">=</span> <span class="n">vn</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">md_in</span><span class="p">,</span> <span class="n">req_in</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;descriptive_stats::request MPI </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">))</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">teca_metadata</span><span class="p">(</span><span class="n">req_in</span><span class="p">)</span>
        <span class="n">req</span><span class="p">[</span><span class="s1">&#39;arrays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_names</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">req</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">data_in</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;descriptive_stats::execute MPI </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">))</span>

        <span class="n">mesh</span> <span class="o">=</span> <span class="n">as_teca_cartesian_mesh</span><span class="p">(</span><span class="n">data_in</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">table</span> <span class="o">=</span> <span class="n">teca_table</span><span class="o">.</span><span class="n">New</span><span class="p">()</span>
        <span class="n">table</span><span class="o">.</span><span class="n">declare_columns</span><span class="p">([</span><span class="s1">&#39;step&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;ul&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">])</span>
        <span class="n">table</span> <span class="o">&lt;&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">get_time_step</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">mesh</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_names</span><span class="p">:</span>

            <span class="n">table</span><span class="o">.</span><span class="n">declare_columns</span><span class="p">([</span><span class="s1">&#39;min &#39;</span><span class="o">+</span><span class="n">var_name</span><span class="p">,</span> <span class="s1">&#39;avg &#39;</span><span class="o">+</span><span class="n">var_name</span><span class="p">,</span> \
                <span class="s1">&#39;max &#39;</span><span class="o">+</span><span class="n">var_name</span><span class="p">,</span> <span class="s1">&#39;std &#39;</span><span class="o">+</span><span class="n">var_name</span><span class="p">,</span> <span class="s1">&#39;low_q &#39;</span><span class="o">+</span><span class="n">var_name</span><span class="p">,</span> \
                <span class="s1">&#39;med &#39;</span><span class="o">+</span><span class="n">var_name</span><span class="p">,</span> <span class="s1">&#39;up_q &#39;</span><span class="o">+</span><span class="n">var_name</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span>

            <span class="n">var</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">get_point_arrays</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>

            <span class="n">table</span> <span class="o">&lt;&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> \
                <span class="o">&lt;&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> \
                <span class="o">&lt;&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="p">[</span><span class="mf">25.</span><span class="p">,</span><span class="mf">50.</span><span class="p">,</span><span class="mf">75.</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">table</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="python-algorithm-template">
<h3>Python Algorithm Template<a class="headerlink" href="#python-algorithm-template" title="Permalink to this headline">¶</a></h3>
<p>To extend TECA using Python one derives from teca_python_algorithm. A template
follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">YOUR_CLASS_NAME</span><span class="p">(</span><span class="n">teca_python_algorithm</span><span class="p">):</span>

    <span class="c1"># YOUR INITIALIZATION CODE</span>

    <span class="c1"># YOUR PROPERTY SETTING CODE</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o_port</span><span class="p">,</span> <span class="n">reports_in</span><span class="p">):</span>
        <span class="c1"># YOUR CODE REPORTING NEW DATA PRODUCED IN</span>
        <span class="c1"># EXECUTE.</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o_port</span><span class="p">,</span> <span class="n">reports_in</span><span class="p">,</span> <span class="n">request_in</span><span class="p">):</span>
        <span class="c1"># YOUR CODE REQUESTING SPECIFIC DATA NEEDED</span>
        <span class="c1"># IN EXECUTE</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o_port</span><span class="p">,</span> <span class="n">data_in</span><span class="p">,</span> <span class="n">request_in</span><span class="p">):</span>
        <span class="c1"># YOUR CODE DO A CALCULATION, TRANSFORM DATA,</span>
        <span class="c1"># OR MAKING A SIDE AFFECT</span>
</pre></div>
</div>
<p>One overrides one por more of the three methods: report, request, and execute.
In addition one can add initialization and properties that control run time
behavior. For instance a writer may use a file_name property to specify the
locatgion on disk to put the data. Typically this would be accessed via a
set_file_name method. The overrides are described in more detail below.</p>
</div>
<div class="section" id="the-report-override">
<h3>The Report Override<a class="headerlink" href="#the-report-override" title="Permalink to this headline">¶</a></h3>
<p>The report override will report the universe of what the algorithm could produce.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o_port</span><span class="p">,</span> <span class="n">reports_in</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">report_out</span>
</pre></div>
</div>
<dl class="simple">
<dt>o_port</dt><dd><p>integer. the output port number to report for. can be ignored for single
output algorithms.</p>
</dd>
<dt>reports_in</dt><dd><p>teca_metadata list. reports describing available data from the next
upstream algorithm, one per input connection.</p>
</dd>
<dt>report_out</dt><dd><p>teca_metadata. the report describing what you could potentially produce
given the data described by reports_in.</p>
</dd>
</dl>
<p>Report stage should be fast and light. Typically the incoming report
is passed through with metadata describing new data that could be produced
appended as needed. This allows upstream data producers to advertise their
capabilities.</p>
</div>
<div class="section" id="the-request-override">
<h3>The Request Override<a class="headerlink" href="#the-request-override" title="Permalink to this headline">¶</a></h3>
<p>The request override generates an up stream request requesting the minimum
amount of data actually needed to fulfill the incoming request.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o_port</span><span class="p">,</span> <span class="n">reports_in</span><span class="p">,</span> <span class="n">request_in</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests_out</span>
</pre></div>
</div>
<dl class="simple">
<dt>o_port</dt><dd><p>integer. the output port number to report for. can be ignored for single output algorithms.</p>
</dd>
<dt>reports_in</dt><dd><p>teca_metadata list. reports describing available data from the next
upstream algorithm, one per input connection.</p>
</dd>
<dt>request_in</dt><dd><p>teca_metadata. the request being made of you.</p>
</dd>
<dt>report_out</dt><dd><p>teca_metadata list. requests describing data that you need to fulfill the
request made of you.</p>
</dd>
</dl>
<p>Typically the incoming request is passed through appending the
necessary metadata as needed. This allows down stream data consumers to request
data that is produced upstream.</p>
</div>
<div class="section" id="the-execute-override">
<h3>The Execute Override<a class="headerlink" href="#the-execute-override" title="Permalink to this headline">¶</a></h3>
<p>The execute override is where the computations or I/O necessary to produce the
requested data are handled.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o_port</span><span class="p">,</span> <span class="n">data_in</span><span class="p">,</span> <span class="n">request_in</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">data_out</span>
</pre></div>
</div>
<dl class="simple">
<dt>o_port</dt><dd><p>integer. the output port number to report for. can be ignored for single
output algorithms.</p>
</dd>
<dt>data_in</dt><dd><p>teca_dataset list. a dataset for each request you made in the request
override in the same order.</p>
</dd>
<dt>request_in</dt><dd><p>teca_metadata. the request being made of you.</p>
</dd>
<dt>data_out</dt><dd><p>teca_dataset. the dataset containing the requested data or the result of
the requested action, if any.</p>
</dd>
</dl>
<p>A simple strategy for generating derived quantities having the same
data layout, for example on a Cartesian mesh or in a table, is to pass the
incoming data through appending the new arrays. This allows down stream data
consumers to receive data that is produced upstream. Because TECA caches data
it is important that incoming data is not modified, this convention enables
shallow copy of large data which saves memory.</p>
<p>Lines 25-27 of listing <a class="reference internal" href="#py-glue-code"><span class="std std-numref">Listing 1</span></a> illustrate the use of
teca_python_algorithm. In this example a class derived from
teca_python_algorithm computes descriptive statistics over a set of variables
laid out on a Cartesian lat-lon mesh. The derived class, descriptive_stats, is
in a separate file, stats_overrides.py (listing <a class="reference internal" href="#py-devel-code"><span class="std std-numref">Listing 2</span></a>)
imported on line 4.</p>
<p>Listing <a class="reference internal" href="#py-devel-code"><span class="std std-numref">Listing 2</span></a> shows the class derived from
teca_python_algorithm that is used in listing <a class="reference internal" href="#py-glue-code"><span class="std std-numref">Listing 1</span></a>.  The
class implements request and execute overrides.  Note, that we did not need to
provide a report override as the default implementation, which passes the
report through was all that was needed. Our request override (lines 15-21 of
listing <a class="reference internal" href="#py-devel-code"><span class="std std-numref">Listing 2</span></a>) simply adds the list of variables we need into
the incoming request which it then forwards up stream. The execute override
(lines 23-45) gets the input dataset (line 27), creates the output table adding
columns and values of time and time step (lines 29-31), then for each variable
we add columns to the table for each computation (line 35), get the array from
the input dataset (line 39), compute statistics and add them to the table
(lines 41-43), and returns the table containing the results (line 45). This
data can then be processed by the next stage in the pipeline.</p>
<div class="section" id="working-with-teca-s-data-structures">
<span id="data-struct"></span><h4>Working with TECA’s Data Structures<a class="headerlink" href="#working-with-teca-s-data-structures" title="Permalink to this headline">¶</a></h4>
</div>
</div>
<div class="section" id="arrays">
<h3>Arrays<a class="headerlink" href="#arrays" title="Permalink to this headline">¶</a></h3>
<p>TODO: illustrate use of teca_variant_array, and role numpy plays</p>
</div>
<div class="section" id="metadata">
<h3>Metadata<a class="headerlink" href="#metadata" title="Permalink to this headline">¶</a></h3>
<p>TOOD: illustrate use of teca_metadata</p>
<p>The Python API for teca_metadata models the standard Python dictionary.
Metadata objects are one of the few cases in TECA where stack based allocation
and deep copying are always used.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">md</span> <span class="o">=</span> <span class="n">teca_metadata</span><span class="p">()</span>
<span class="n">md</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Land Mask&#39;</span>
<span class="n">md</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">]</span>

<span class="n">md2</span> <span class="o">=</span> <span class="n">teca_metadata</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
<span class="n">md2</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="array-collections">
<h3>Array Collections<a class="headerlink" href="#array-collections" title="Permalink to this headline">¶</a></h3>
<p>TODO: illustrate teca_array_collection, tabular and mesh based datasets are implemented in terms of collections of arrays</p>
</div>
<div class="section" id="tables">
<h3>Tables<a class="headerlink" href="#tables" title="Permalink to this headline">¶</a></h3>
<p>TODO: illustrate use of teca_table</p>
</div>
<div class="section" id="cartesian-meshes">
<h3>Cartesian Meshes<a class="headerlink" href="#cartesian-meshes" title="Permalink to this headline">¶</a></h3>
<p>TODO: illustrate use of teca_cartesian_mesh</p>
<div class="section" id="netcdf-cf-reader-metadata">
<span id="cf-reader"></span><h4>NetCDF CF Reader Metadata<a class="headerlink" href="#netcdf-cf-reader-metadata" title="Permalink to this headline">¶</a></h4>
<p>TODO: document metadata conventions employed by the reader</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="developer.html" class="btn btn-neutral float-right" title="Development" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="applications.html" class="btn btn-neutral float-left" title="Applications" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, Burlen Loring, Travis O&#39;Brien &amp; Abdelrahman Elbashandy

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>